<workflow-app name="${workflowName}" xmlns="uri:oozie:workflow:0.5">

    <global>
        <job-tracker>${jobTracker}</job-tracker>
        <name-node>${nameNode}</name-node>
        <configuration>
            <property>
                <name>oozie.action.sharelib.for.pig</name>
                <value>pig,hcatalog</value>
            </property>
            <property>
                <name>mapreduce.job.queue.name</name>
                <value>${yarnQueue}</value>
            </property>
            <property>
                <name>hive.metastore.uris</name>
                <value>${hiveMetastoreUris}</value>
            </property>
        </configuration>
    </global>

    <!-- Oozie starting action -->
    <start to="create_table"/>

    <!-- Hive action (CREATE TABLE) -->
    <action name="create_table">
        <hive xmlns="uri:oozie:hive-action:0.5">
            <script>lib/cancelled_flights.sql</script>
            <param>db=${db}</param>
            <param>output_table=${output_table}</param>
        </hive>
        <ok to="pig_job"/>
        <error to="kill"/>
    </action>

    <!-- Pig action -->
    <action name="pig_job">
        <pig>
            <script>lib/cancelled_flights.pig</script>
            <param>udf_jar_path=${udf_jar_path}</param>
            <param>db=${db}</param>
            <param>airports_table=${airports_table}</param>
            <param>iata_code=${iata_code}</param>
            <param>flights_table=${flights_table}</param>
            <param>start_date=${start_date}</param>
            <param>end_date=${end_date}</param>
            <param>output_table=${output_table}</param>
            <param>user_name=${user.name}</param>
            <param>wf_id=${wf:id()}</param>
        </pig>
        <ok to="end"/>
        <error to="kill"/>
    </action>

    <!-- Kill node (mandatory) -->
    <kill name="kill">
        <message>Action failed, error message[${wf:errorMessage(wf:lastErrorNode())}]</message>
    </kill>

    <!-- End node (mandatory) -->
    <end name="end"/>

</workflow-app>